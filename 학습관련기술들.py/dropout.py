"""
μ¤λ²„ν”Όν…μ€ μ£Όλ΅ λ‹¤μμ κ²½μ°μ— μΌμ–΄λ‚λ‹¤.
 * λ§¤κ°λ³€μκ°€ λ§κ³  ν‘ν„λ ¥μ΄ λ†’μ€ λ¨λΈ
 * ν›λ ¨ λ°μ΄ν„°κ°€ μ μ

"""


# μ¤λ²„ν”Όν… λ§‰λ” λ°©λ²•
# 1) κ°€μ¤‘μΉ κ°μ†
# 2) λ“λ΅­μ•„μ›ƒ μ‚¬μ©

import numpy as np

class Dropout:
    def __init__(self, dropout_ratio=0.5):
        """
        λ“λ΅­μ•„μ›ƒ(Dropout) ν΄λμ¤  
        - dropout_ratio: λ“λ΅­μ•„μ›ƒ λΉ„μ¨ (κΈ°λ³Έκ°’ 0.5)
        - mask: ν™μ„± λ‰΄λ°μ„ κ²°μ •ν•λ” λ§μ¤ν¬
        """
        self.dropout_ratio = dropout_ratio
        self.mask = None  # ν•™μµ μ¤‘ ν™μ„±ν™”ν•  λ‰΄λ°μ„ μ €μ¥ν•λ” λ§μ¤ν¬

    def forward(self, x, train_flg=True):
        """
        μμ „ν (Forward)  
        - ν•™μµ μ¤‘(train_flg=True)μΌ λ•: λ‰΄λ°μ„ λλ¤μΌλ΅ λΉ„ν™μ„±ν™”  
        - ν…μ¤νΈ μ¤‘(train_flg=False)μΌ λ•: λ“λ΅­μ•„μ›ƒ λΉ„μ¨μ„ λ°μν•΄ μ¶λ ¥κ°’ μ΅°μ •
        """
        if train_flg:
            # μ…λ ¥κ³Ό κ°™μ€ shapeμ λλ¤ ν–‰λ ¬ μƒμ„± (dropout_ratioλ³΄λ‹¤ ν¬λ©΄ 1, μ‘μΌλ©΄ 0)
            self.mask = np.random.rand(*x.shape) > self.dropout_ratio  
            return x * self.mask  # μ„ νƒλ λ‰΄λ°λ§ ν™μ„±ν™”
        else:
            return x * (1.0 - self.dropout_ratio)  # ν…μ¤νΈ μ‹ λ“λ΅­μ•„μ›ƒ ν¨κ³Ό λ³΄μ •

    def backward(self, dout):
        """
        μ—­μ „ν (Backward)  
        - λ“λ΅­λ λ‰΄λ°μ€ 0μ΄λ―€λ΅, λ―Έλ¶„κ°’λ„ ν•΄λ‹Ή λ¶€λ¶„μ€ 0μΌλ΅ μ μ§€
        """
        return dout * self.mask if self.mask is not None else dout  # mask μ μ©

# ν…μ¤νΈ μ½”λ“

# μ…λ ¥ λ°μ΄ν„° μƒμ„± (3x3 ν–‰λ ¬)
x = np.array([[1.0, 2.0, 3.0], 
              [4.0, 5.0, 6.0], 
              [7.0, 8.0, 9.0]])

dropout = Dropout(0.5)  # λ“λ΅­μ•„μ›ƒ λΉ„μ¨ 50%

# ν•™μµ μ¤‘ (train_flg=True)
train_output = dropout.forward(x, train_flg=True)
print("Train Output:\n", train_output)

# ν…μ¤νΈ μ¤‘ (train_flg=False)
test_output = dropout.forward(x, train_flg=False)
print("Test Output:\n", test_output)

# μ—­μ „ν ν…μ¤νΈ
dout = np.ones_like(x)  # λ¨λ‘ 1μΈ λ―Έλ¶„κ°’
backprop_output = dropout.backward(dout)
print("Backward Output:\n", backprop_output)

"""

ν•™μµ μ¤‘(Train Output)μ—μ„ λ“λ΅­μ•„μ›ƒ ν¨κ³Ό ν™•μΈ

Train Output:
 [[1. 2. 0.]
  [4. 0. 0.]
  [7. 8. 0.]]
μ…λ ¥ λ°μ΄ν„° xμ—μ„ μΌλ¶€ κ°’μ΄ 0μ΄ λμ—μ–΄μ”.
λ“λ΅­μ•„μ›ƒ ν™•λ¥ μ΄ 50%μ΄λ―€λ΅, μ•½ μ λ° μ •λ„μ λ‰΄λ°μ΄ λΉ„ν™μ„±ν™”λμ—μ–΄μ”.
μλ¥Ό λ“¤μ–΄, (1,1), (1,2), (2,1) λ“±μ€ μ‚΄μ•„λ‚¨μ•κ³ , (1,3), (2,2), (2,3) λ“±μ€ 0μ΄ λμ—μ–΄μ”.
μ΄ κ³Όμ •μ—μ„ λλ¤ν• λ‰΄λ°μ„ λ„λ”(drop) μ—­ν• μ„ ν•λ‹¤λ” κ±Έ ν™•μΈν•  μ μμ–΄μ”.

2. ν…μ¤νΈ μ¤‘(Test Output)μ—μ„ μ¤μΌ€μΌ μ΅°μ • ν™•μΈ

Test Output:
 [[0.5 1.  1.5]
  [2.  2.5 3. ]
  [3.5 4.  4.5]]
ν•™μµ μ¤‘μ—λ” λ‰΄λ°μ„ μΌλ¶€ λ„μ§€λ§, ν…μ¤νΈν•  λ•λ” λ¨λ“  λ‰΄λ°μ„ μ‚¬μ©ν•΄μ•Ό ν•΄μ”.
κ·Έλμ„ ν…μ¤νΈ λ‹¨κ³„μ—μ„λ” μ¶λ ¥κ°’μ„ (1 - dropout_ratio) λ§νΌ κ³±ν•΄μ„ λ³΄μ •ν•΄μ”.
μ—¬κΈ°μ„λ” 0.5λ¥Ό κ³±ν–μ–΄μ”.
μλ¥Ό λ“¤μ–΄, μ›λ μ…λ ¥κ°’μ΄ 1.0μ΄μ—λ‹¤λ©΄ 1.0 * 0.5 = 0.5κ°€ λ κ±°μμ”.

3. μ—­μ „ν(Backward Output)μ—μ„ μν–¥ ν™•μΈ
Backward Output:
 [[1. 1. 0.]
  [1. 0. 0.]
  [1. 1. 0.]]
μμ „ν λ• 0μ΄ λ λ‰΄λ°μ€ μ—­μ „νμ—μ„λ„ 0μΌλ΅ μ μ§€λΌμ”.
λ‰΄λ°μ΄ λΉ„ν™μ„±ν™”λμ—μΌλ‹, ν•΄λ‹Ή λ‰΄λ°μ— λ€ν• λ―Έλ¶„ κ°’λ„ κ³„μ‚°ν•μ§€ μ•λ” κ±°μ£ .
μλ¥Ό λ“¤μ–΄, (1,3), (2,2), (2,3), (3,3) μ„μΉλ” μμ „ν λ• 0μ΄μ—κ³ , μ—­μ „νμ—μ„λ„ 0μ΄ μ μ§€λμ—μ–΄μ”.

π” κ²°λ΅ : ν…μ¤νΈλ¥Ό ν†µν•΄ ν™•μΈν• μ 
β… ν•™μµ μ¤‘μ—λ” μΌλ¶€ λ‰΄λ°μ„ λλ¤μΌλ΅ λ„λ”(drop) κ³Όμ •μ΄ μ μ©λ¨
β… ν…μ¤νΈν•  λ•λ” μ¶λ ¥κ°’μ„ λ³΄μ •ν•΄μ„ μ „μ²΄ λ‰΄λ°μ„ ν™μ©ν•  μ μλ„λ΅ ν•¨
β… μ—­μ „ν κ³Όμ •μ—μ„λ„ λΉ„ν™μ„±ν™”λ λ‰΄λ°μ€ κ·Έλ€λ΅ 0μ΄ μ μ§€λ¨

λ“λ΅­μ•„μ›ƒμ΄ μ–΄λ–»κ² ν•™μµ μ¤‘ κ³Όμ ν•©μ„ λ°©μ§€ν•λ”μ§€ μ§μ ‘ ν™•μΈν•  μ μλ” μΆ‹μ€ ν…μ¤νΈμ€μ–΄μ”! π€

"""